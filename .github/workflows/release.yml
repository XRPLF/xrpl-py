name: Debug Build + GitHub Release (verify softprops finalize)

on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: "Git ref to build/release (branch, tag, or SHA)"
        required: true
        type: string

jobs:
  build-and-release:
    name: Build artifacts + create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write   # create release + upload assets
      id-token: write   # sigstore signing

    env:
      POETRY_VERSION: 2.1.1

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.git_ref }}

      - name: Install Poetry
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          curl -sSL https://install.python-poetry.org/ | python3 - --version "${POETRY_VERSION}"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "poetry"

      - name: Extract version from pyproject.toml
        id: ver
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import tomllib
          with open("pyproject.toml","rb") as f:
            data = tomllib.load(f)
          v = data["project"]["version"]
          print(f"version={v}")
          PY
          VERSION="$(python3 - <<'PY'
          import tomllib
          with open("pyproject.toml","rb") as f:
            data = tomllib.load(f)
          print(data["project"]["version"])
          PY
          )"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION"

      - name: Determine prerelease flag (a/b/rc)
        id: relkind
        run: |
          set -euo pipefail
          v="${{ steps.ver.outputs.version }}"
          if [[ "$v" =~ (a|b|rc) ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi
          echo "is_prerelease=${{ steps.relkind.outputs.is_prerelease || '' }}"

      - name: Build wheel + sdist
        run: |
          set -euo pipefail
          poetry build
          ls -lah dist

      - name: Sign dists with Sigstore
        uses: sigstore/gh-action-sigstore-python@v3.0.1
        with:
          inputs: >-
            ./dist/*.tar.gz
            ./dist/*.whl

      # === VERIFICATION: what will be uploaded ===
      - name: DEBUG - list and count release assets (dist)
        run: |
          set -euo pipefail
          echo "=== dist files ==="
          find dist -type f -maxdepth 2 -print | sort
          echo
          echo "count=$(find dist -type f | wc -l | tr -d ' ')"
          echo
          echo "=== sizes ==="
          du -ah dist | sort -hr | head -n 20

      - name: DEBUG - GitHub rate limit before release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh api rate_limit --jq '
            "core: \(.resources.core.remaining)/\(.resources.core.limit) reset=\(.resources.core.reset)\n" +
            "graphql: \(.resources.graphql.remaining)/\(.resources.graphql.limit) reset=\(.resources.graphql.reset)\n"
          '

      - name: Create GitHub Release and upload assets (softprops)
        id: softprops_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tag_name: v${{ steps.ver.outputs.version }}
          target_commitish: ${{ github.event.inputs.git_ref }}
          draft: false
          generate_release_notes: true
          prerelease: ${{ steps.relkind.outputs.is_prerelease == 'true' }}
          make_latest: ${{ steps.relkind.outputs.is_prerelease != 'true' }}
          files: |
            dist/**

      - name: DEBUG - GitHub rate limit after release
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh api rate_limit --jq '
            "core: \(.resources.core.remaining)/\(.resources.core.limit) reset=\(.resources.core.reset)\n" +
            "graphql: \(.resources.graphql.remaining)/\(.resources.graphql.limit) reset=\(.resources.graphql.reset)\n"
          '

      - name: DEBUG - If softprops failed, inspect release + try publish via API
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          TAG: v${{ steps.ver.outputs.version }}
          IS_PRERELEASE: ${{ steps.relkind.outputs.is_prerelease }}
        run: |
          set -euo pipefail
          echo "Softprops failed. Inspecting release state for tag: $TAG"

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release view "$TAG" --json url,isDraft,isPrerelease,publishedAt,assets \
              --jq '{url,isDraft,isPrerelease,publishedAt,assetCount:(.assets|length)}'
          else
            echo "Release does not exist for $TAG"
            exit 0
          fi

          rid="$(gh api -q '.id' "repos/$REPO/releases/tags/$TAG")"
          prerelease_flag="false"
          if [[ "$IS_PRERELEASE" == "true" ]]; then prerelease_flag="true"; fi

          echo "Attempting to publish (PATCH draft=false) and print any API error..."
          set +e
          resp="$(gh api --method PATCH -H "Accept: application/vnd.github+json" \
            "repos/$REPO/releases/$rid" \
            -f draft=false \
            -f prerelease="$prerelease_flag" 2>&1)"
          rc=$?
          set -e

          if (( rc == 0 )); then
            echo "✅ Publish PATCH succeeded."
          else
            echo "❌ Publish PATCH failed (real reason should be here):"
            echo "$resp"
            exit 1
          fi
