name: Publish xrpl-py 🐍 distribution 📦 to PyPI
on:
  workflow_dispatch:
  push:


jobs:
  input-validate:
    name: Validate release inputs
    runs-on: ubuntu-latest
    outputs:
      package_version: ${{ steps.package_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate inputs
        run: |
          set -euo pipefail
          RELEASE_BRANCH="$(git branch --show-current || true)"
          if [[ -z "$RELEASE_BRANCH" ]]; then
            RELEASE_BRANCH="${{ github.ref_name }}"
          fi

          if [[ -z "$RELEASE_BRANCH" ]]; then
            echo "❌ Unable to determine branch name." >&2
            exit 1
          fi

          if [[ ! "${RELEASE_BRANCH,,}" =~ ^release[-/] ]]; then
            echo "❌ Release branch '$RELEASE_BRANCH' must start with 'release-' or 'release/'." >&2
            exit 1
          fi

          if grep -R --exclude-dir=.git --exclude-dir=.github "artifactory.ops.ripple.com" .; then
            echo "❌ Internal Artifactory URL found"
            exit 1
          else
            echo "✅ No Internal Artifactory URL found"
          fi

      - name: Install toml-cli
        run: |
          set -euo pipefail
          python3 -m venv /tmp/tomlcli
          /tmp/tomlcli/bin/pip install --upgrade pip
          /tmp/tomlcli/bin/pip install toml-cli
          echo "/tmp/tomlcli/bin" >> "${GITHUB_PATH}"

      - name: Extract package version
        id: package_version
        run: |
          set -euo pipefail

          rm -f /tmp/toml_err
          if ! VERSION="$(toml get project.version --toml-path pyproject.toml 2>/tmp/toml_err)"; then
            cat /tmp/toml_err >&2 || true
            echo "Unable to retrieve version from pyproject.toml using toml-cli" >&2
            exit 1
          fi
          rm -f /tmp/toml_err
          if [[ -z "${VERSION}" ]]; then
            echo "Version value is empty in pyproject.toml" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "Detected package version: ${VERSION}"

  faucet-tests:
    name: Run faucet tests matrix
    needs:
      - input-validate
    uses: ./.github/workflows/faucet_test.yml
    secrets: inherit

  integration-tests:
    name: Run integration tests matrix
    needs:
      - input-validate
    uses: ./.github/workflows/integration_test.yml
    secrets: inherit

  pre-release:
    name: Pre-release distribution 📦
    needs:
      - input-validate
      - faucet-tests
      - integration-tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write
      issues: write
    env:
      POETRY_VERSION: 2.1.1
      PACKAGE_VERSION: ${{ needs.input-validate.outputs.package_version }}
    outputs:
      package_version: ${{ needs.input-validate.outputs.package_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # Use the lowest supported version of Python for CI/CD
          python-version: "3.9"
      - name: Load cached .local
        id: cache-poetry
        uses: actions/cache@v3
        with:
          path: /home/runner/.local
          key: dotlocal-${{ env.POETRY_VERSION }}-${{ hashFiles('poetry.lock') }}
      - name: Install poetry
        env:
          PIP_INDEX_URL: https://pypi.org/simple
          PIP_NO_CACHE_DIR: "1"
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install "dulwich>=0.22.6,<0.23.0"
          python -m pip install "https://github.com/python-poetry/poetry/releases/download/${POETRY_VERSION}/poetry-${POETRY_VERSION}-py3-none-any.whl"
          poetry --version
      - name: Build a binary wheel and a source tarball
        run: poetry build
      - name: Store the distribution packages
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
      - name: Generate build provenance attestation
        id: provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: "dist/*"
      - name: Store provenance attestation
        if: steps.provenance.outputs.bundle-path != ''
        uses: actions/upload-artifact@v4
        with:
          name: python-package-provenance
          path: ${{ steps.provenance.outputs.bundle-path }}
      - name: Install CycloneDX Python tool
        run: |
          set -euo pipefail
          python -m pip install --upgrade cyclonedx-bom
      - name: Generate CycloneDX SBOM
        run: |
          set -euo pipefail
          cyclonedx-py poetry --outfile sbom.json
          cat sbom.json
      - name: Scan SBOM for vulnerabilities using Trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: sbom
          scan-ref: sbom.json
          format: table
          exit-code: 0
          output: vuln-report.txt
          severity: CRITICAL,HIGH
      - name: Upload sbom to OWASP
        run: |
          set -euo pipefail
          curl -X POST \
            -H "X-Api-Key: ${{ secrets.OWASP_TOKEN }}" \
            -F "project=7c40c8ea-ea0f-4a5f-9b9f-368e53232397" \
            -F "bom=@sbom.json" \
            https://owasp-dt-api.prod.ripplex.io/api/v1/bom
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
      - name: Print scan report
        run: cat vuln-report.txt
      - name: Upload vulnerability report artifact
        id: upload_vuln
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report
          path: vuln-report.txt
      - name: Build vuln artifact URL
        id: vuln_art
        run: |
          set -euo pipefail
          echo "art_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ steps.upload_vuln.outputs.artifact-id }}" >> "$GITHUB_OUTPUT"
      - name: Check vulnerabilities in report
        id: check_vulns
        shell: bash
        env:
          REPORT_PATH: vuln-report.txt
        run: |
          set -euo pipefail
          if grep -qE "CRITICAL|HIGH" "$REPORT_PATH"; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Create GitHub Issue for vulnerabilities
        if: steps.check_vulns.outputs.found == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PKG_VER: ${{ env.PACKAGE_VERSION }}
          REL_BRANCH: ${{ github.ref_name }}
          VULN_ART_URL: ${{ steps.vuln_art.outputs.art_url }}
          LABELS: security
        run: |
          set -euo pipefail
          TITLE="🔒 Security vulnerabilities in xrpl-py@${PKG_VER}"
          : > issue_body.md
          {
            echo "The vulnerability scan has detected **CRITICAL/HIGH** vulnerabilities for \`xrpl-py@${PKG_VER}\` on branch \`${REL_BRANCH}\`."
            echo ""
            echo "**Release Branch:** \`${REL_BRANCH}\`"
            echo "**Package Version:** \`${PKG_VER}\`"
            echo ""
            echo "**Full vulnerability report:** ${VULN_ART_URL}"
            echo ""
            echo "Please review the report and take necessary action."
            echo ""
            echo "---"
            echo "_This issue was automatically generated by the Publish to PyPI workflow._"
          } >> issue_body.md
          gh issue create --title "$TITLE" --body-file issue_body.md --label "$LABELS"
  publish-to-pypi:
    name: >-
      Publish Python 🐍 distribution 📦 to PyPI
    needs: pre-release # Explicit dependency on pre-release job
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Adjust based on typical publishing time
    environment:
      name: official-release
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    env:
      PACKAGE_VERSION: ${{ needs.pre-release.outputs.package_version }}
    permissions:
      # More information about Trusted Publishing and OpenID Connect: https://blog.pypi.org/posts/2023-04-20-introducing-trusted-publishers/
      id-token: write # IMPORTANT: mandatory for trusted publishing
    steps:
      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
      - name: Verify downloaded artifacts
        run: |
          ls dist/*.whl dist/*.tar.gz || exit 1
      - name: Publish distribution 📦 to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true
          verify-metadata: true
          attestations: true

  github-release:
    name: >-
      Sign the Python 🐍 distribution 📦 with Sigstore
      and upload them to GitHub Release
    needs:
      - pre-release
      - publish-to-pypi
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Adjust based on typical signing and release time

    permissions:
      contents: write # IMPORTANT: mandatory for making GitHub Releases
      id-token: write # IMPORTANT: mandatory for sigstore
    env:
      PACKAGE_VERSION: ${{ needs.pre-release.outputs.package_version }}

    steps:
      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
      - name: Download provenance attestations
        uses: actions/download-artifact@v4
        with:
          name: python-package-provenance
          path: provenance/
      - name: Sign the dists with Sigstore
        uses: sigstore/gh-action-sigstore-python@v3.0.1
        with:
          inputs: >-
            ./dist/*.tar.gz
            ./dist/*.whl
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: >-
          gh release create
          '${{ github.ref_name }}'
          --repo '${{ github.repository }}'
          --generate-notes ||
          (echo "::error::Failed to create release" && exit 1)
      - name: Upload artifact signatures to GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
          # Upload to GitHub Release using the `gh` CLI.
          # `dist/` contains the built packages, and the
          # sigstore-produced signatures and certificates.
        run: >-
          gh release upload
          '${{ github.ref_name }}'
          dist/**
          provenance/**
          --repo '${{ github.repository }}'
